---

pre-commit:
  parallel: true
  jobs:
    - name: golangci-lint config verify
      run: bin/golangci-lint config verify
    - group:
        # Go linters and formatters
        jobs:
          - name: Run gofumpt
            run: bin/gofumpt -l -w .
          - name: Run newline-after-block linter
            run: bin/newline-after-block -fix ./...
          - name: Run golangci-lint
            run: bin/golangci-lint run --fix ./...
    - name: Lint markdown files
      run: markdownlint-cli2 --fix --files '**/*.md' '!.scratch/**' '!.beads/**' '!docs/**'

pre-push:
  # Since some jobs might update files (e.g., go mod tidy), we cannot run them in parallel
  # parallel: true
  jobs:
    - name: Check go mod tidy
      run: go mod tidy && git diff --exit-code go.mod go.sum
    - name: Check go generate
      run: go generate ./... && git diff --exit-code -- '**/*_gen.go' '**/*_gen_test.go'
    - group:
        # Dogfood hooks
        jobs:
          - name: Build all hooks
            run: go build -v -o bin/commit-msg-lint github.com/breml/githooks/cmd/commit-msg-lint
          - name: Run all hooks
            run: bin/commit-msg-lint
            use_stdin: true
    - name: Run acceptance tests
      env:
        TF_ACC: "1"
      run: go test -v -shuffle on -timeout 480s ./...
